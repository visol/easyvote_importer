<f:layout name="Default" />

<f:section name="left">
	<div class="csc-default box-pink">
		Schritt 2/3
	</div>
	<div class="csc-default box-lightblue">
		<h2>Zuweisung der Spaltentitel</h2>
		<p>Ein Essay zu einem spannenden Thema</p>
		<p>Sollten Sie die falsche Liste hochgeladen haben, können Sie diese Liste verwerfen und eine neue Adressliste hochladen.</p>
		<f:form id="deleteDocument" action="remove">
			<f:form.hidden name="dataset" value="{dataset}" />
			<button type="submit"><i class="icon-upload-alt"></i> Neue Adressliste</button>
		</f:form>
	</div>
</f:section>
<f:section name="main">
	<div class="csc-default box-blue">
		<div id="assignColumns">
			<div class="sortingColumns left">
				<h3>Spalten Ihrer Tabelle:</h3>
				<ul id="source" class="connected">
					<f:for each="{tableData}" as="tableDataItem" iteration="iterator">
						<li class="value" data-column="{iterator.index}" data-example="{tableDataItem.firstItem}" id="col-{iterator.index}">
							{tableDataItem.name}<br />
							<em>Beispiel: {tableDataItem.firstItem}</em>
						</li>
					</f:for>
				</ul>
			</div>
			<div class="sortingColumns">
				<h3>Spalten der easyvote-Tabelle:</h3>
				<ul id="target-salutation" class="target connected">
					<li id="name" class="category static ui-state-default">
						Anrede
						<div class="sortable-placeholder">Hier ablegen...</div>
					</li>
				</ul>
				<ul id="target-name" class="target connected">
					<li id="name" class="category static ui-state-default">
						Vorname, Nachname
						<div class="sortable-placeholder">Hier ablegen...</div>
					</li>
				</ul>
				<ul id="target-address" class="target connected">
					<li id="address" class="category static ui-state-default">
						Strasse, Nr.
						<div class="sortable-placeholder">Hier ablegen...</div>
					</li>
				</ul>
				<ul id="target-city" class="target connected">
					<li id="city" class="category static ui-state-default">
						PLZ, Ort
						<div class="sortable-placeholder">Hier ablegen...</div>
					</li>
				</ul>
			</div>
			<div class="clear"></div>
			<div class="spacer"></div>
			<f:form id="columnAssignment" action="approve" onsubmit="return validateForm();" >
				<f:form.hidden name="dataset" value="{dataset}" />
				<f:if condition="{businessUser.uid}">
					<f:then>
						<f:form.hidden name="city" value="{businessUser.uid}" />
					</f:then>
					<f:else>
						<f:form.hidden name="city" value="{businessUser}" />
					</f:else>
				</f:if>
				<input class="validate" type="hidden" data-label="Anrede" id="columns-salutation" name="tx_easyvoteimporter_datamanager[columns-salutation]" value="" />
				<input class="validate" type="hidden" data-label="Vorname, Nachname" id="columns-name" name="tx_easyvoteimporter_datamanager[columns-name]" value="" />
				<input class="validate" type="hidden" data-label="Strasse, Nr." id="columns-address" name="tx_easyvoteimporter_datamanager[columns-address]" value="" />
				<input class="validate" type="hidden" data-label="PLZ, Ort" id="columns-city" name="tx_easyvoteimporter_datamanager[columns-city]" value="" />
				<button type="submit" class="buttonBottomRight"><i class="icon-ok-sign"></i> Zuweisung bestätigen und freigeben</button>
			</f:form>

		</div>
	</div>
	<script>
		<![CDATA[
		$(function() {
			$("#source, .target").sortable({
				connectWith: ".connected",
				cancel: ".static",
				stop: function(event, ui) {
					reflectChange(event);
					$('.sortable-placeholder').hide();
				},
				start: function(evento, ui) {
					$('.sortable-placeholder').fadeIn();
				}
			}).disableSelection();
			$('#source, .target').bind('sortstart', function(event, ui) {
				$('.sortable-placeholder').text('Hier ablegen.');
			});

		});

		function reflectChange(event) {
			$('.target').each(function() {
				// example: target-name
				targetId = $(this).attr('id');
				// example: name
				targetType = targetId.split('-')[1];

				// the container for the preview
				$('span#preview-' + targetType).empty();
				// empty the input field containing the column IDs
				$('input#columns-' + targetType).val('');
				$('li.value', this).each(function() {
					// write example data to the corresponding container
					exampleData = $(this).attr('data-example');
					column = $(this).attr('data-column');
					$('span#preview-' + targetType).append(exampleData + '&nbsp;');
					$('input#columns-' + targetType).val($('input#columns-' + targetType).val() + column + ',');
				});

			});
		}

		function validateForm() {
			var errorMessages = '';
			$('input.validate', 'form#columnAssignment').each(function() {
				if (!$(this).val()) {
					errorMessages += 'Dem Adressfeld "'+ $(this).attr('data-label') + '" muss mindestens eine Spalte zugewiesen sein.\n';
				}
			});
			if (errorMessages) {
				alert(errorMessages);
				return false;
			}
		}
		]]>
	</script>
</f:section>
<f:section name="right">
	<div class="csc-default box-lightblue">
		<h2>Vorschau</h2>
		<p class="preview">
			<span id="preview-salutation"></span><br />
			<span id="preview-name"></span><br />
			<span id="preview-address"></span><br />
			<span id="preview-city"></span>
		</p>
	</div>
</f:section>